- alias: Turn off study
  trigger:
    - platform: state
      entity_id: binary_sensor.rst_emu_smo
      to: 'off'
      for:
        seconds: 20
    - platform: state
      entity_id: sensor.average_apartment_luminance
    - platform: state
      entity_id: input_text.last_movement
  condition:
    - condition: template
      value_template: "{{ not is_state('input_text.last_movement', 'Study') }}"
    - condition: state
      entity_id: binary_sensor.rst_emu_smo
      state: 'off'
    - condition: template
      value_template: "
  {{
    is_state('binary_sensor.artificial_light','off') or 
    (not is_state('input_text.last_movement', 'Study') and is_state('binary_sensor.rst_emu_smo', 'off'))
  }}"  
  action:
    service: light.turn_off
    data_template:
      entity_id: light.study
      transition: >
            {% if states.switch.circadian_lighting_circadian_lighting.attributes["brightness"] | int >= 10 %}
              10
            {% else %}
              1
            {% endif %}